import pickle 
import streamlit as st
import numpy as np
import pandas as pd

class results():
    def run(self):
        st.header('Model Results')
       
        st.write('Gradient Boost')
        st.image('plots\GradientBoost.png')
        
        st.write('Random Forest')
        st.image('plots\RandomForest.png')
            
        st.write('Logistic Regression')
        st.image('plots\LogisticReg.png')
 
        # st.write('Precision Vs Recall curve')
        # st.image('plots\curve_pr.png')
        
        # st.write('accuracy_score: 0.9441922675415704')
        # st.write('f1_score: 0.8937189921276614')
    
class predict():
    def run(self):
        with open('Model/pickle/model.pkl', 'rb') as f:
            model = pickle.load(f)
        
        with open(r'Model/pickle/scaler.pkl', 'rb') as f:
            scaler = pickle.load(f)
                
        def data_preprocess(app_name,file_format,ram_usage, behaviour_of_the_device, automatic_or_manual, verified_by,digital_signature_found,browser,passed_browser_firewall,website_name,cpu_usage):
            
            with open('Model/pickle/dataset.xlsx', 'rb') as f:
                df_temp = pd.read_excel(f)

            with open(r'Model/pickle/app_name.pkl', 'rb') as f:
                    temp = pickle.load(f)
                    app_name = temp.transform(np.array(app_name).reshape(-1,1))
                    
            with open(r'Model/pickle/file_format.pkl', 'rb') as f:
                    temp = pickle.load(f)
                    file_format = temp.transform(np.array(file_format).reshape(-1,1))
            
            # with open(r'Model/pickle/permissions_taken.pkl', 'rb') as f:
            #         temp = pickle.load(f)
            #         permissions_taken = temp.transform(np.array(permissions_taken).reshape(-1,1))
            
            with open(r'Model/pickle/verified_by.pkl', 'rb') as f:
                    temp = pickle.load(f)
                    verified_by = temp.transform(np.array(verified_by).reshape(-1,1))
                    
            with open(r'Model/pickle/browser.pkl', 'rb') as f:
                    temp = pickle.load(f)
                    browser = temp.transform(np.array(browser).reshape(-1,1))
                    
            with open(r'Model/pickle/website_name.pkl', 'rb') as f:
                    temp = pickle.load(f)

                    if website_name not in df_temp['website_name']:
                        website_name = "Others"

                    website_name = temp.transform(np.array(website_name).reshape(-1,1))
                    
            # encoding the binary columns
            if behaviour_of_the_device=='Normal':
                behaviour_of_the_device =1
            else:
                behaviour_of_the_device=0
                
            if automatic_or_manual=='Manual':
                automatic_or_manual =1
            else:
                automatic_or_manual=0
            
            if digital_signature_found=='yes':
                digital_signature_found =1
            else:
                digital_signature_found=0
            
            if passed_browser_firewall=='yes':
                passed_browser_firewall =1
            else:
                passed_browser_firewall=0
                                
            new_values = np.array([app_name,file_format,ram_usage, behaviour_of_the_device, automatic_or_manual, verified_by,digital_signature_found,browser,passed_browser_firewall,website_name,cpu_usage]).reshape(-1,11)
            print(new_values)
            data = scaler.transform(new_values)
            print("after scaler",data)
            predict_class(data)
            
        def predict_class(data):
            
            data = np.array(data).reshape(-1,11)
            result = model.predict_proba(data)[0,1]
            pd.DataFrame(data,columns=['app_name','file_format','ram_usage', 'behaviour_of_the_device', 'automatic_or_manual', 'verified_by','digital_signature_found','browser','passed_browser_firewall','website_name','cpu_usage']).to_csv('Model/data.csv',index=False)
            if result>=0.5:
                st.write("The probability of the app ", app_name,"to be malicious is ",str (round(result,2)*100) +' %')
                url="This download is highly likely to be malicious kindly avoid the installation"
                st.markdown(f'<p style="background-color:#FFFFFF;color:	##FF0000;font-size:24px;border-radius:2%;">{url}</p>', unsafe_allow_html=True)
            else:
                st.write("The probability of the app ", app_name,"to be malicious is ",str (round(result,2)*100) +' %')
        st.markdown("#")
        st.markdown("**Please enter the details of the App to find the probability of it to be a malicious**")
        # st.markdown(f'<p> click on <a href=r"C:\\Users\\manoj\\Desktop\\FINAL\\LIVE\\streamlit\\application_analysis_malicious_or_not\\help_file.py">help</a> section in case you got stuck</p>', unsafe_allow_html=True)
        app_name = st.selectbox('Enter the app name',('Andes Shop','Avatar Mobile','Baywtch','BeReady','Bookoread','Caint','Crayze','DeskGet','Enmeet','Fdeam','Gniteem','Gusto Mobile','Ingocal','Koob','Kulop','LilyGrate','Lopping','Man Mobile','MemoMe','Mettcal','MyGameNight','Nime','OrTravel','Orty','Others','Page One Shop','Paize','Partnip','Plalitaire','Prayons','ReadABook','Redsky','Resinagro',
'ROF','Rook','Run24','ShopFactory','Shoplist', 'Shost','Sist','Solaplay','Solo Mobile','SolSol','Tracking Mobile','Trafor','Vrigo',
'Yalp','Yola','Ytrap',))
        file_format = st.selectbox('Enter the file format',('EXE','PDF','ZIP','JPG','OTHERS'))
        ram_usage = st.number_input('Enter the ram usage')
        
        behaviour_of_the_device = st.selectbox('Enter the behaviour of the device after download',('Normal','Abnormal'))
        automatic_or_manual = st.selectbox('Enter if the download is Manual or Automatic',('Automatic','Manual'))
        cpu_usage = st.number_input('Enter the cpu usage')
        verified_by = st.selectbox('Enter the verification details',('microsoft store','not known','App Store','Play Store'))
        digital_signature_found = st.selectbox('Enter if the digital signature is found',('yes','no'))
        browser = st.selectbox('Enter the browser',('Edge','Firefox','Google','Tor','Yahoo'))
        passed_browser_firewall = st.selectbox('Enter if the download passed the browser firewall',('yes','no'))
        website_name = st.text_input('Enter the website_name')
        
        if st.button("Predict"):
            data_preprocess(app_name,file_format,ram_usage, behaviour_of_the_device, automatic_or_manual, verified_by,digital_signature_found,browser,passed_browser_firewall,website_name,cpu_usage)
        
        